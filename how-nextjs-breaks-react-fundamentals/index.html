<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">How Next.js breaks React Fundamentals (Examples) | Ondrej Velisek</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ondrejvelisek.github.io/how-nextjs-breaks-react-fundamentals/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="How Next.js breaks React Fundamentals (Examples) | Ondrej Velisek"><meta data-rh="true" name="description" content="In the front-end world, there&#x27;s an ongoing war over performance."><meta data-rh="true" property="og:description" content="In the front-end world, there&#x27;s an ongoing war over performance."><meta data-rh="true" property="og:image" content="https://ondrejvelisek.github.io/assets/images/rendering-runtime-b80dd32377a2dd069b774c13fe0a6880.png"><meta data-rh="true" name="twitter:image" content="https://ondrejvelisek.github.io/assets/images/rendering-runtime-b80dd32377a2dd069b774c13fe0a6880.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-03-19T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ondrejvelisek.github.io/how-nextjs-breaks-react-fundamentals/"><link data-rh="true" rel="alternate" href="https://ondrejvelisek.github.io/how-nextjs-breaks-react-fundamentals/" hreflang="en"><link data-rh="true" rel="alternate" href="https://ondrejvelisek.github.io/how-nextjs-breaks-react-fundamentals/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://ondrejvelisek.github.io/how-nextjs-breaks-react-fundamentals","mainEntityOfPage":"https://ondrejvelisek.github.io/how-nextjs-breaks-react-fundamentals","url":"https://ondrejvelisek.github.io/how-nextjs-breaks-react-fundamentals","headline":"How Next.js breaks React Fundamentals (Examples)","name":"How Next.js breaks React Fundamentals (Examples)","description":"In the front-end world, there's an ongoing war over performance.","datePublished":"2024-03-19T00:00:00.000Z","author":[],"image":{"@type":"ImageObject","@id":"https://ondrejvelisek.github.io/assets/images/rendering-runtime-b80dd32377a2dd069b774c13fe0a6880.png","url":"https://ondrejvelisek.github.io/assets/images/rendering-runtime-b80dd32377a2dd069b774c13fe0a6880.png","contentUrl":"https://ondrejvelisek.github.io/assets/images/rendering-runtime-b80dd32377a2dd069b774c13fe0a6880.png","caption":"title image for the blog post: How Next.js breaks React Fundamentals (Examples)"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://ondrejvelisek.github.io/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Ondrej Velisek RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Ondrej Velisek Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BZWT5GPVTE"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BZWT5GPVTE",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.41670f90.css">
<script src="/assets/js/runtime~main.f5bada20.js" defer="defer"></script>
<script src="/assets/js/main.05c474a9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/ondrejvelisek-logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_vI9N" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/ondrejvelisek-logo.svg" alt="ondrejvelisek Logo" class="themedComponent_x2kJ themedComponent--light_yLPm"><img src="/img/ondrejvelisek-logo.svg" alt="ondrejvelisek Logo" class="themedComponent_x2kJ themedComponent--dark_ndWy"></div></a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_DudH"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MWqU"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_DpSO thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_yzVa margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_uu0Z">2024</h3><ul class="sidebarItemList_Rq9m clean-list"><li class="sidebarItem_tvmX"><a aria-current="page" class="sidebarItemLink_DPHx sidebarItemLinkActive_B_1E" href="/how-nextjs-breaks-react-fundamentals/">How Next.js breaks React Fundamentals (Examples)</a></li><li class="sidebarItem_tvmX"><a class="sidebarItemLink_DPHx" href="/conceptual-model-of-react-and-rsc/">Conceptual Model of React and RSC</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_uu0Z">2022</h3><ul class="sidebarItemList_Rq9m clean-list"><li class="sidebarItem_tvmX"><a class="sidebarItemLink_DPHx" href="/practical-limits-of-react-hooks-recursion/">Practical limits of React hooks - Recursion</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_PojJ">How Next.js breaks React Fundamentals (Examples)</h1><div class="container_Huic margin-vert--md"><time datetime="2024-03-19T00:00:00.000Z">March 19, 2024</time> · <!-- -->14 min read</div></header><div id="__blog-post-container" class="markdown"><p>In the front-end world, there&#x27;s an ongoing war over performance.
RSC (React Server Components), currently implemented in the Next.js App router, serve as the official weapon aimed at improving startup performance.
However, it seems that in the midst of this battle, we&#x27;ve forgotten about some fundamentals, resulting in a degraded DX (Developer Experience).
This article aims to provide examples of such DX issues in the current Next.js API.
Towards the end, I outline a better proposal.</p>
<!-- -->
<p>I want to make it explicitly clear that it&#x27;s not my intention to blame, dishonor, or offend React and Next.js maintainers.
I have respect for each one of them and appreciate their work. Thank you for your contributions.
However, at the same time, I want to present what I believe is wrong about the current API design in a clear and constructive manner.
This way, we can foster a discussion based on specific examples.</p>
<p>This article loosely follows on from my previous piece, <a href="/conceptual-model-of-react-and-rsc/">Conceptual Model of React and RSC</a>.
Reading it beforehand will provide better context for the following text, which I highly recommend.</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="dx--performance">DX &gt; Performance<a href="#dx--performance" class="hash-link" aria-label="Direct link to DX &gt; Performance" title="Direct link to DX &gt; Performance">​</a></h2>
<p>First of all, let me defend the idea that <abbr title="Developer Experience">DX</abbr> is more important than performance in terms of framework API design.</p>
<p>What do I, as an app developer, do when a change requirement arrives?
I throw some nasty components on a screen and start crafting.
I add basic visuals, connect real data, make it interactive, improve styles, add loading, error, and empty UI, write tests, refactor component structure, solve bugs, optimize performance.</p>
<p>I usually do it in this order. I&#x27;m sure each of us prefers a different order. Some do <abbr title="Test Driven Development">TTD</abbr>,
some like to start with a pixel-perfect design with mockup data. It&#x27;s okay.
However, no devs I know care about performance at first.
Actually, some believe it is bad practice and should be avoided.
Donald E. Knuth believes &quot;Premature optimization is the root of all evil.&quot; or
Michael A. Jackson stated, &quot;First rule of optimization: Don&#x27;t do it.&quot;</p>
<p>To be crystal clear: I&#x27;m not trying to convince you to not take a performance-first approach.
I&#x27;m trying to convince you that many developers do not optimize at first. And it works well for us.
A general-purpose framework should, at least, support, but better embrace this flow.
Fast delivery supported by great <abbr title="Developer Experience">DX</abbr> with the best possible performance out-of-the-box.
Then provide easy optimization tooling like refactoring patterns, optimizer hinting, more aggressive caching config, etc.</p>
<p>Personally, I&#x27;m okay if a framework brings some syntax overhead due to performance optimization.
But it is unacceptable for me to hurt the clear conceptual model and fundamental principles.</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="fundamentals">Fundamentals<a href="#fundamentals" class="hash-link" aria-label="Direct link to Fundamentals" title="Direct link to Fundamentals">​</a></h2>
<p>In the <a href="/conceptual-model-of-react-and-rsc/">previous article</a>, I described a set of fundamental properties I believe any front-end framework should follow to provide a good <abbr title="Developer Experience">DX</abbr>. Let&#x27;s quickly recap them.</p>
<ol>
<li>
<p><strong>Composable</strong> - Or Homogeneity. The ability to compose components into the full UI.
Ability to place any component into any other component without changing its behavior.</p>
</li>
<li>
<p><strong>Reusable</strong> - The ability to define a name and reuse a component in a different place. Also, it involves passing arbitrary configuration (possibly reactive state) to adjust its behavior (props).</p>
</li>
<li>
<p><strong>Colocated</strong> - The ability to place all dependencies inside a component: name, render logic, necessary state connections, state derivation logic, styling, documentation, etc. If this is not met, developers have to jump back and forth in a codebase.</p>
</li>
<li>
<p><strong>Encapsulated</strong> - The ability to work on a component independently. All paths to affect the component from outside should be blocked by default. Breaking the barrier, for example, by exposing props, should be an opt-in feature. If this is not met, developers must mentally consider other code pieces.</p>
</li>
<li>
<p><strong>Reactive</strong> - A component must react to the connected state chosen by the developer. Any component must be able to connect to any state, and the same applies to derivation hooks. If certain rules are required, development becomes jammed.</p>
</li>
<li>
<p><strong>Arbitrary</strong> - The component&#x27;s boundaries must obey the developer&#x27;s needs. Nothing must force a component to split or not to split, as it would destroy its purpose.</p>
</li>
</ol>
<p>It seems to me that Next&#x27;s implementation of <abbr title="React Server Components">RSC</abbr> breaks some of these fundamental properties due to their performance-first design. Examples follow now.</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="sample-component">Sample Component<a href="#sample-component" class="hash-link" aria-label="Direct link to Sample Component" title="Direct link to Sample Component">​</a></h2>
<p>Imagine a requirement to create a page with a random quote about programming on each page refresh. Quotes are saved in a remote database.
How would you implement it in the Next.js App router?</p>
<p>Next.js <a href="https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating" target="_blank" rel="noopener noreferrer">data fetching docs</a>
suggest a simple async-await function within the component render function.
Let&#x27;s assume we have the <code>random(from, to)</code> lodash-like function for brevity.</p>
<div class="language-tsx codeBlockContainer_t37y theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#212432"><div class="codeBlockContent_evnz"><pre tabindex="0" class="prism-code language-tsx codeBlock_eucs thin-scrollbar" style="color:#9CDCFE;background-color:#212432"><code class="codeBlockLines_ir7E"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ProgrammingQuotes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// Here I want to connect to the external database state of quotes </span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> quotes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">fetch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;/quotes&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// Here I want to connect to a random number state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">random</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> quotes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">div</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">quotes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">div</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup_WgNt"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Grdj" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_cxvn"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I15G"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Just place it somewhere on a page and we&#x27;re done. Excellent <abbr title="Developer Experience">DX</abbr> so far.
It&#x27;s a server-only component by default. Resulting in a small bundle, no client-server round trips,
great <abbr title="First Contentful Paint">FCP</abbr> and <abbr title="Largest Contentful Paint">LCP</abbr>,
No <abbr title="Cumulative Layout Shift">CLS</abbr>. Awesome startup performance as promised.</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="1-forced-to-lift-state-up">1. Forced to Lift State up<a href="#1-forced-to-lift-state-up" class="hash-link" aria-label="Direct link to 1. Forced to Lift State up" title="Direct link to 1. Forced to Lift State up">​</a></h2>
<p>Imagine a change requirement. Our UX department likes the component and wants it in an existing comments feed modal.
This modal is currently a client component. Somebody just wrote it as client because it needs some client-side state.</p>
<div class="language-tsx codeBlockContainer_t37y theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#212432"><div class="codeBlockContent_evnz"><pre tabindex="0" class="prism-code language-tsx codeBlock_eucs thin-scrollbar" style="color:#9CDCFE;background-color:#212432"><code class="codeBlockLines_ir7E"><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&#x27;use client&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">FeedModal</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> setOpen</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">useState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag class-name" style="color:rgb(78, 201, 176)">Button</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">toggle</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token tag script language-javascript" style="color:rgb(78, 201, 176)">setOpen</span><span class="token tag script language-javascript punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain-text">Show comments</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag class-name" style="color:rgb(78, 201, 176)">Button</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag class-name" style="color:rgb(78, 201, 176)">Modal</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">opened</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token tag script language-javascript" style="color:rgb(78, 201, 176)">opened</span><span class="token tag script language-javascript punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain-text">         </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag class-name" style="color:rgb(78, 201, 176)">Feed</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line code-block-error-line" style="color:#9CDCFE"><span class="token plain-text">         </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag class-name" style="color:rgb(78, 201, 176)">ProgrammingQuotes</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag class-name" style="color:rgb(78, 201, 176)">Modal</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup_WgNt"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Grdj" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_cxvn"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I15G"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>...Oops. <mark class="error">&quot;Error: Client component can&#x27;t be async&quot;</mark>. What happened? <code>&#x27;use client&#x27;</code> makes all of its descendants client components.
But our <code>ProgrammingQuotes</code> assumes it is a server component.
I see three options for how to solve it with current Next.js abilities.</p>
<p>a. <strong>Use client-side</strong> data fetching solutions like <code>tanstack-query</code>, <code>useSWC</code>, or the new <code>use</code> React API. This means giving up on RSC and its performance benefits.</p>
<p>b. <strong>Lift fetch up</strong> into a first server ancestor. It is not enough to lift quotes fetching to <code>FeedModal</code>.
We need to go higher and then drill the fetched quote data via props.
The code <strong>Colocation</strong> property is torn apart.</p>
<p>c. <strong>Refactor modules</strong> so <code>ProgrammingQuotes</code> is passed as children to <code>FeedModal</code>.
However, it forces me to compose components in a certain way. It does not obey my needs and therefore breaks the <strong>Arbitrary</strong> boundary property.
Furthermore, I&#x27;m forced to expose a children prop. Which breaks the <strong>Encapsulation</strong> property.</p>
<p>All of the options have a negative impact on my work. Either on performance or worse project maintainability.</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="2-forced-to-split-a-component">2. Forced to Split a Component<a href="#2-forced-to-split-a-component" class="hash-link" aria-label="Direct link to 2. Forced to Split a Component" title="Direct link to 2. Forced to Split a Component">​</a></h2>
<p>Imagine a change requirement. A quote is not random but should change every five seconds in the order received from a database.
A way to access some counting state is with <code>setInterval</code> so let&#x27;s use it.
I would adjust our component like this:</p>
<div class="language-tsx codeBlockContainer_t37y theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#212432"><div class="codeBlockContent_evnz"><pre tabindex="0" class="prism-code language-tsx codeBlock_eucs thin-scrollbar" style="color:#9CDCFE;background-color:#212432"><code class="codeBlockLines_ir7E"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ProgrammingQuotes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> quotes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">fetch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;/quotes&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">useCounter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">div</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">quotes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">div</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">useCounter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">delay</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// This hook is simplified for brevity</span><span class="token plain"></span><br></span><span class="token-line code-block-error-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> setCount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">useState</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line code-block-error-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">useEffect</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">setInterval</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(212, 212, 212)">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">setCount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">count </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> delay</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> count</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup_WgNt"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Grdj" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_cxvn"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I15G"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>...Oops. <mark class="error">&quot;Error: Server component can&#x27;t use &#x27;useState&#x27; and &#x27;useEffect&#x27; hooks&quot;</mark>.
Since server components can&#x27;t react to time changes (in other words, they can&#x27;t reactively connect to time state), we need to use a client component.
So maybe add <code>&quot;use client&quot;</code> to the top of the file?
...Oops. <mark class="error">&quot;Error: Client component can&#x27;t be async&quot;</mark>. What do we do?
I see the following options:</p>
<p>a. <strong>Use client-side fetching</strong>, but as stated above, we give up on <abbr title="React Server Components">RSC</abbr> and their performance.</p>
<p>b. <strong>Lift fetch up</strong>, but as stated, it breaks the code <strong>Colocation</strong>.</p>
<p>c. <strong>Split the component</strong> into a server parent and a client child. The parent is async with <code>fetch</code>, and the child uses <code>useCounter</code>. However, we are actually forced to put them into separate file modules.
So we end up with dislocated code. <strong>Colocation</strong> is broken anyway.</p>
<p>Again, I have no good choice. I have to sacrifice.
At this point, let me remind you of a talk about the importance of colocation
by Dan Abramov in his <a href="https://www.youtube.com/watch?v=dpw9EHDh2bM&amp;t=2600s" target="_blank" rel="noopener noreferrer">Introduction of hooks (YouTube)</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="3-forced-to-prop-drilling">3. Forced to Prop Drilling<a href="#3-forced-to-prop-drilling" class="hash-link" aria-label="Direct link to 3. Forced to Prop Drilling" title="Direct link to 3. Forced to Prop Drilling">​</a></h2>
<p>Imagine a change requirement. We want to add quotes filtered by author. The author is placed in the URL query param, so it can be shared, and only quotes of such author appear.
After the previous example, we end up with two components.</p>
<div class="language-tsx codeBlockContainer_t37y theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#212432"><div class="codeBlockContent_evnz"><pre tabindex="0" class="prism-code language-tsx codeBlock_eucs thin-scrollbar" style="color:#9CDCFE;background-color:#212432"><code class="codeBlockLines_ir7E"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ProgrammingQuotesServer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">// Here I want to connect to the URL query param state</span><span class="token plain"></span><br></span><span class="token-line code-block-error-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> author </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">useSearchParam</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;author&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> quotes </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">fetch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token template-string template-punctuation string" style="color:rgb(206, 145, 120)">`</span><span class="token template-string string" style="color:rgb(206, 145, 120)">/quotes?author=</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(212, 212, 212)">${</span><span class="token template-string interpolation">author</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token template-string template-punctuation string" style="color:rgb(206, 145, 120)">`</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag class-name" style="color:rgb(78, 201, 176)">ProgrammingQuotesClient</span><span class="token tag" style="color:rgb(78, 201, 176)"> </span><span class="token tag attr-name" style="color:rgb(156, 220, 254)">quotes</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token tag script language-javascript" style="color:rgb(78, 201, 176)">quotes</span><span class="token tag script language-javascript punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup_WgNt"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Grdj" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_cxvn"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I15G"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-tsx codeBlockContainer_t37y theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#212432"><div class="codeBlockContent_evnz"><pre tabindex="0" class="prism-code language-tsx codeBlock_eucs thin-scrollbar" style="color:#9CDCFE;background-color:#212432"><code class="codeBlockLines_ir7E"><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">&#x27;use client&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">ProgrammingQuotesClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> quotes </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">const</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">useCounter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:rgb(181, 206, 168)">5000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;</span><span class="token tag" style="color:rgb(78, 201, 176)">div</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">quotes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&lt;/</span><span class="token tag" style="color:rgb(78, 201, 176)">div</span><span class="token tag punctuation" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup_WgNt"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Grdj" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_cxvn"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_I15G"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://nextjs.org/docs/app/api-reference/functions/use-search-params#server-components" target="_blank" rel="noopener noreferrer">Next.js docs</a>
suggest <code>useSearchParam</code> hook or <code>searchParams</code> props.</p>
<p>So let&#x27;s try <code>useSearchParam</code> first.
...Oops. <mark class="error">&quot;Error: Server component can&#x27;t use &#x27;useSearchParam&#x27; hook&quot;</mark>
Okay. <code>searchParams</code> prop will help. ...Oops. This prop is accessible only in the top-level page component.
I see the following options:</p>
<p>a. <strong>Use client-side fetching</strong> means no RSC benefits.</p>
<p>b. <strong>Drill props</strong> down from the top-level page. In large apps with a deep component tree, this is unmaintainable.</p>
<p>c. <strong>Create context</strong> for URL params and then access it with <code>useContext</code> from the server component. Uf, a lot of work for such a basic use-case.
But it&#x27;s solved, and I can reuse this context for all other URL params and all components, right?</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="4-forced-to-give-up-on-server">4. Forced to Give up on Server<a href="#4-forced-to-give-up-on-server" class="hash-link" aria-label="Direct link to 4. Forced to Give up on Server" title="Direct link to 4. Forced to Give up on Server">​</a></h2>
<p>Imagine a last change requirement. This little component should be moved to a footer component. The footer is in a page layout component tree.
...Oops. <code>searchParams</code> prop is inaccessible in layouts. What do I do? It&#x27;s very frustrating, but it seems I need to refactor and convert it to a client component to be able to use <code>useSearchParam</code>.
...Oops. <mark class="error">&quot;Error: Client component can&#x27;t be async&quot;</mark>.
Am I just being forced to choose between server-side fetching or Next.js layouts feature?</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>Those simple examples break most of the defined rules.
The <code>ProgrammingQuotes</code> component can&#x27;t be easily reused in a modal or footer.
Its code is dislocated into several modules.
The author search query is inaccessible from the component itself.
I&#x27;m forced to expose children as a component prop
and create artificial Client and Server components.</p>
<p>I want to emphasize that these examples are not some edge-case nonsense. Similar requirements come up every day.
I&#x27;m 100% sure that at least one example has happened to every developer who creates some non-trivial app in the Next.js App router.
I truly believe Colocation, Encapsulation, and Arbitrary composition are crucial properties for efficient development.
They are necessary for team cooperation and maintaining mid-large codebases.
Especially for long-term projects with many change requirements over the years where many developers read and manipulate the code and need to quickly understand what is happening.
That&#x27;s the reason I&#x27;m writing this. So we can design better framework APIs.</p>
<p>Many of you argue that I can use the old client-side approach and then gradually move to the server.
Start with a full client-side app and if performance is needed, push the client boundary down through a component tree.
You are smart.
I see three catches. 1. this is not recommended nor mentioned by the Next.js team. 2. <abbr title="In My Opinion">IMO</abbr> is too much work.
Both, writing but more importantly mental.
It is not just putting <code>&#x27;use client&#x27;</code> at the top of the module, but also modifying async code, using different methods to access URLs, refactor component boundaries and more.
3. I believe there is a way to provide better out-of-the-box performance without compromising on DX.
And still keep the ability to achieve the same performance as current Next.js with an easier optimization path.</p>
<h2 class="anchor anchorWithStickyNavbar_BFL_" id="a-better-approach">A Better Approach<a href="#a-better-approach" class="hash-link" aria-label="Direct link to A Better Approach" title="Direct link to A Better Approach">​</a></h2>
<p>In Next.js implementation of RSC, we define if a component is server or client at the module level.
If the compiler sees <code>&#x27;use client&#x27;</code>, the code is bundled and shipped to the client. It stays server-only otherwise.
In other words, we are choosing where a component is rendered, respectively its runtime environment.
This component runtime then limits its capabilities, e.g., using async fetching or client state.</p>
<p>The last example with layouts limits component capabilities based on a module too.
If the compiler sees a file named <code>layout.tsx</code>, its components are considered &quot;more static&quot;.
Some more dynamic state like search params can&#x27;t be used.</p>
<p>I believe <mark>component capabilities should never be limited by a module-level configuration</mark>.
Any component must be capable of using any feature. <mark>Where rendered and when re-rendered should be deduced automatically</mark>
by features used within the component.</p>
<p>Both runtime environment and re-rendering frequency are unrelated to my business goals.
Ideally, it is an implementation detail and a framework should shield me from it.
The best-performing strategy should be chosen by the framework automatically.
It is the same as how re-rendering works on the client nowadays. Developers use some state within a component, and it re-renders when the state changes.
No manual tweaking of shouldComponentUpdate. The same applies to signals.</p>
<p>Paradoxically, Next.js inspired me with this idea.
It chooses between build and request-time rendering based on <a href="https://nextjs.org/docs/app/building-your-application/rendering/server-components#dynamic-functions" target="_blank" rel="noopener noreferrer">Dynamic functions</a>
used within the component.
For <a href="https://nextjs.org/docs/app/api-reference/file-conventions/layout#layouts-do-not-receive-searchparams" target="_blank" rel="noopener noreferrer">some reason</a>, they limit this deduction in layouts.
I believe this automatic deduction concept should be used more broadly.</p>
<p><img decoding="async" loading="lazy" alt="Components runtime environment rendering diagram" src="/assets/images/rendering-runtime-b80dd32377a2dd069b774c13fe0a6880.png" width="2480" height="1080" class="img_jf__">
</p><p style="text-align:center"><em>Components go through runtimes and if some state is needed, they re-render. Pass the runtime otherwise.</em></p><p></p>
<p>In the end, let&#x27;s think together about this algorithm of automatic runtime environment deduction.
First of all, what environments do we have available, respectively where could the component be rendered?
For sure on a client in a browser. Also on a server. We should distinguish between static rendering during build and dynamic rendering during server request.
There are more flavors, like edge runtime or <abbr title="Deferred Static Generation">DSG</abbr>, but let&#x27;s stick with just those three for now.
Let&#x27;s sort them by performance. For most cases, it is like this: Build, Server, Client.
I want to choose the most performant automatically if nothing forces me otherwise.</p>
<p>What forces a component to use a less performant runtime? It is when a component needs some more dynamic or interactive features, respectively connects to some kind of dynamic or interactive state.
When a component connects to <code>searchParam</code>, <code>cookie</code>, or <code>headers</code>, those states are not known during build-time and it must be rendered during server request.
This is what Next.js does with dynamic functions I mentioned above.
Similarly, when a component connects to <code>useState</code>, <code>setInterval</code>, or <code>onMouseEnter</code>, it must be rendered on the client because those states are not accessible on the server.</p>
<p>I hope your head is screaming now &quot;But Ondrej, it would not work! Bundling is a compile-time feature!&quot;.
If so, I&#x27;ve done a good job explaining my thoughts. Congratulations. You understand the concept correctly.
There are many questions to be answered.
What if a callback function is passed to a component as a prop?
Are there situations a component is rendered in multiple runtimes?
Many details are unresolved. But let&#x27;s stop here.</p>
<p>I plan to write a following article where I dive into the API of a new fictional framework and also touch some implementation possibilities.
Until then, I invite you to think about its DX benefits and how you would implement it. Try to think how and not why can&#x27;t.
And let me know what you think.</p>
<p>Thanks for reading.</p>
<!-- -->
<div class="flex gap-2 w-full flex-wrap my-8"><a href="https://x.com/search?q=https%3A%2F%2Fondrejvelisek.github.io%2Fhow-nextjs-breaks-react-fundamentals%2F" class="hover:no-underline px-4 py-3 border-solid border rounded border-zinc-700 text-white">Discuss on <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="x-twitter" class="svg-inline--fa fa-x-twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"></path></svg></a><a href="https://www.reddit.com/r/nextjs/comments/1bipvwe/how_nextjs_breaks_react_fundamentals_with_examples/" class="hover:no-underline px-4 py-3 border-solid border rounded border-zinc-700 text-white">Discuss on <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="reddit-alien" class="svg-inline--fa fa-reddit-alien" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M373 138.6c-25.2 0-46.3-17.5-51.9-41l0 0c-30.6 4.3-54.2 30.7-54.2 62.4l0 .2c47.4 1.8 90.6 15.1 124.9 36.3c12.6-9.7 28.4-15.5 45.5-15.5c41.3 0 74.7 33.4 74.7 74.7c0 29.8-17.4 55.5-42.7 67.5c-2.4 86.8-97 156.6-213.2 156.6S45.5 410.1 43 323.4C17.6 311.5 0 285.7 0 255.7c0-41.3 33.4-74.7 74.7-74.7c17.2 0 33 5.8 45.7 15.6c34-21.1 76.8-34.4 123.7-36.4l0-.3c0-44.3 33.7-80.9 76.8-85.5C325.8 50.2 347.2 32 373 32c29.4 0 53.3 23.9 53.3 53.3s-23.9 53.3-53.3 53.3zM157.5 255.3c-20.9 0-38.9 20.8-40.2 47.9s17.1 38.1 38 38.1s36.6-9.8 37.8-36.9s-14.7-49.1-35.7-49.1zM395 303.1c-1.2-27.1-19.2-47.9-40.2-47.9s-36.9 22-35.7 49.1c1.2 27.1 16.9 36.9 37.8 36.9s39.3-11 38-38.1zm-60.1 70.8c1.5-3.6-1-7.7-4.9-8.1c-23-2.3-47.9-3.6-73.8-3.6s-50.8 1.3-73.8 3.6c-3.9 .4-6.4 4.5-4.9 8.1c12.9 30.8 43.3 52.4 78.7 52.4s65.8-21.6 78.7-52.4z"></path></svg></a><a href="https://dev.to/ondrejvelisek/how-nextjs-breaks-react-fundamentals-with-examples-2lof" class="hover:no-underline px-4 py-3 border-solid border rounded border-zinc-700 text-white">Discuss on <svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="dev" class="svg-inline--fa fa-dev" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg></a></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/conceptual-model-of-react-and-rsc/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Conceptual Model of React and RSC</div></a></nav></main><div class="col col--2"><div class="tableOfContents_XeQp thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#dx--performance" class="table-of-contents__link toc-highlight">DX &gt; Performance</a></li><li><a href="#fundamentals" class="table-of-contents__link toc-highlight">Fundamentals</a></li><li><a href="#sample-component" class="table-of-contents__link toc-highlight">Sample Component</a></li><li><a href="#1-forced-to-lift-state-up" class="table-of-contents__link toc-highlight">1. Forced to Lift State up</a></li><li><a href="#2-forced-to-split-a-component" class="table-of-contents__link toc-highlight">2. Forced to Split a Component</a></li><li><a href="#3-forced-to-prop-drilling" class="table-of-contents__link toc-highlight">3. Forced to Prop Drilling</a></li><li><a href="#4-forced-to-give-up-on-server" class="table-of-contents__link toc-highlight">4. Forced to Give up on Server</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#a-better-approach" class="table-of-contents__link toc-highlight">A Better Approach</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright"><div class="flex justify-between">
        <div>Copyright © 2025 Ondrej Velisek</div>
        <div>Made with ❤️ in Czech republic.</div>
      </div></div></div></div></footer></div>
</body>
</html>