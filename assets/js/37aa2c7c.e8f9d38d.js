"use strict";(self.webpackChunk_torrta_docs=self.webpackChunk_torrta_docs||[]).push([[580],{7408:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var t=s(7e3),o=s(7472);const i={},r="Conceptual model of React and RSC",a={permalink:"/2024/02/23/conceptual model-of-react-and-rsc",source:"@site/blog/2024-02-23-conceptual model-of-react-and-rsc/index.md",title:"Conceptual model of React and RSC",description:"Building web apps is a complex problem. We need simple high-level mental structures to support such heavy load.",date:"2024-02-23T00:00:00.000Z",formattedDate:"February 23, 2024",tags:[],readingTime:8.315,hasTruncateMarker:!0,authors:[],frontMatter:{},unlisted:!1,nextItem:{title:"Practical limits of React hooks - Recursion",permalink:"/2022/03/23/practical-limits-of-react-hooks-recursion"}},c={authorsImageUrls:[]},l=[{value:"What is <code>state</code>?",id:"what-is-state",level:2},{value:"What is <code>UI</code>?",id:"what-is-ui",level:2},{value:"What the f* is <em><code>f</code></em>?",id:"what-the-f-is-f",level:2},{value:"Connecting state",id:"connecting-state",level:2},{value:"Developer experience",id:"developer-experience",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["Building web apps is a complex problem. We need simple high-level mental structures to support such heavy load.\nThey allow us to offload unnecessary details out of our brains. So we can focus on important parts of our code.\n",(0,t.jsx)(n.code,{children:"UI = f(state)"})," is one of them. Every one of us knows this formula. But do you know what it reflects in the real world?\nWhat is ",(0,t.jsx)(n.code,{children:"UI"}),"? What is ",(0,t.jsx)(n.code,{children:"state"}),"? What the f* is ",(0,t.jsx)(n.em,{children:(0,t.jsx)(n.code,{children:"f"})}),"? And how it is affected by RSC (React Server Components)? Here is my view."]}),"\n",(0,t.jsx)(n.p,{children:"First of all:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"I reckon the state mutates. But I ignore how it is mutated."}),"\n",(0,t.jsx)(n.li,{children:"I show examples of React but most of the following applies for other UI frameworks like Angular, Vue, Svelte, Qwik or Solid."}),"\n"]}),"\n",(0,t.jsxs)(n.h2,{id:"what-is-state",children:["What is ",(0,t.jsx)(n.code,{children:"state"}),"?"]}),"\n",(0,t.jsxs)(n.p,{children:["Look again: ",(0,t.jsx)(n.code,{children:"UI = f(state)"}),". In other words ",(0,t.jsx)(n.code,{children:"state"})," is what our ",(0,t.jsx)(n.code,{children:"UI"})," depends on. If dependency changes, we want to change the ",(0,t.jsx)(n.code,{children:"UI"}),". It is called ",(0,t.jsx)(n.strong,{children:"reactivity"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["I believe the state is more than just in-memory local component state (",(0,t.jsx)(n.code,{children:"useState"}),") or in-memory global app state (Redux, Jotai, Zustand).\nI'm not alone (\n",(0,t.jsx)(n.a,{href:"https://tkdodo.eu/blog/react-query-as-a-state-manager",children:"TkDodo"}),",\n",(0,t.jsx)(n.a,{href:"https://www.youtube.com/watch?v=ukpgxEemXsk",children:"ByteGrad (YouTube)"}),",\n",(0,t.jsx)(n.a,{href:"https://x.com/kentcdodds/status/1349173470567964673",children:"Kent C. Dodds"}),",\n",(0,t.jsx)(n.a,{href:"https://daverupert.com/2024/02/ui-states/",children:"Dave Rupert"}),",\n",(0,t.jsx)(n.a,{href:"https://overreacted.io/the-two-reacts/",children:"Dan Abramov"}),"\n). Many devs agrees at least URL and server data are some kind of state too. But I think it is much more."]}),"\n",(0,t.jsxs)(n.p,{children:["Lets place some ",(0,t.jsx)(n.code,{children:"UI"})," examples:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Blog post UI depends on slug present in ",(0,t.jsx)(n.strong,{children:"URL"})," address."]}),"\n",(0,t.jsxs)(n.li,{children:["Server files UI explorer depends on ",(0,t.jsx)(n.strong,{children:"server"})," files."]}),"\n",(0,t.jsxs)(n.li,{children:["Newest movies list UI depends on ",(0,t.jsx)(n.strong,{children:"third-party"})," resource of OMDB."]}),"\n",(0,t.jsxs)(n.li,{children:["Ticking clock UI depends on ",(0,t.jsx)(n.strong,{children:"time"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Drawing canvas UI depends on mouse position of user ",(0,t.jsx)(n.strong,{children:"input device"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["User profile UI depends on session token stored in ",(0,t.jsx)(n.strong,{children:"cookie"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Keep me signed on this device UI depends on flag in ",(0,t.jsx)(n.strong,{children:"local storage"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["OS prefered dark mode UI depends on ",(0,t.jsx)(n.strong,{children:"OS setting"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Devtools debug UI depends on ",(0,t.jsx)(n.strong,{children:"env variable"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Panoramatic background UI depends on scroll position of ",(0,t.jsx)(n.strong,{children:"DOM"})," element."]}),"\n",(0,t.jsx)(n.li,{children:"... OK you got the idea."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["I call those states ",(0,t.jsx)(n.strong,{children:"source states"}),". Its important to say that state may be ",(0,t.jsx)(n.em,{children:"derived"}),". Examples:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Current post ",(0,t.jsx)(n.em,{children:"slug"})," depends on ",(0,t.jsx)(n.strong,{children:"URL"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Current post ",(0,t.jsx)(n.em,{children:"minutes read"})," depends on ",(0,t.jsx)(n.em,{children:"slug"})," and ",(0,t.jsx)(n.strong,{children:"server files"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Current ",(0,t.jsx)(n.em,{children:"user role"})," depends on authorization data in ",(0,t.jsx)(n.strong,{children:"server database"})," and session token from ",(0,t.jsx)(n.strong,{children:"cookie"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.em,{children:"Prefered dark mode"})," depends on ",(0,t.jsx)(n.strong,{children:"local storage"})," and ",(0,t.jsx)(n.strong,{children:"OS setting"})," (storage as user preference and OS as default)."]}),"\n",(0,t.jsxs)(n.li,{children:["minutes value in pausible stopwatch depends on ",(0,t.jsx)(n.strong,{children:"time"})," and spacebar ",(0,t.jsx)(n.strong,{children:"pressed key"})]}),"\n",(0,t.jsx)(n.li,{children:"... got it?"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Derived state depends on another state. And should change when its dependencies changes.\nIn other words, be reactive. Here is a great deep-dive from ",(0,t.jsx)(n.a,{href:"https://reacttraining.com/blog/derived-state",children:"React Training - Derived State"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["The boundary between ",(0,t.jsx)(n.strong,{children:"source"})," and ",(0,t.jsx)(n.em,{children:"derived"}),' states are blurry. e.g. server database, local storage, OS settings, all of those depends on file system data.\nBut lets mark state as "source" when it depends solely on states inaccessible by available technologies.\ne.g. I cant access some private browser file with local storage data from browser window environment.']}),"\n",(0,t.jsxs)(n.p,{children:["I would like to be explicit and distinguish between in-memory state and all those kind of states.\nI name it for myself a holistic state philosophy and ",(0,t.jsx)(n.strong,{children:"Holistic state"}),"."]}),"\n",(0,t.jsxs)(n.h2,{id:"what-is-ui",children:["What is ",(0,t.jsx)(n.code,{children:"UI"}),"?"]}),"\n",(0,t.jsxs)(n.p,{children:["It is what users perceive with their senses. Usually with eyes on screen. On web it is represented with ",(0,t.jsx)(n.strong,{children:"DOM"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"The wilderness out there is more diverse.\nOur user might me a machine like search indexing bot. But they also work on DOM elements and attributes.\nThere could be assistive technologies like screen reader. Working on DOM either.\nVery important piece of UI is URL in browser address bar. Since it is always in sync with URL state, I like to think about it as source state rather than UI.\nUser also perceives playing sounds, haptic vibration feedback, flashlight etc.\nLets simplify and stick with DOM only. Worth to say following applies to other UI pieces similarly."}),"\n",(0,t.jsx)(n.p,{children:"As dev I expect framework to provide tools to describe UI and update DOM when description changes.\nIn React and Vue those tools are JSX and VDOM. In Solid it is signal dependency graph."}),"\n",(0,t.jsxs)(n.p,{children:["Note I cassified DOM as both ",(0,t.jsx)(n.code,{children:"UI"})," and ",(0,t.jsx)(n.code,{children:"holistic_state"}),". If we use DOM as source state and let our UI depends on it, we create cyclic dependency.\nSometimes it is necessary e.g. when measuring text width. Be careful in such situation to not create infinite loops. Same applies for URL."]}),"\n",(0,t.jsxs)(n.h2,{id:"what-the-f-is-f",children:["What the f* is ",(0,t.jsx)(n.em,{children:(0,t.jsx)(n.code,{children:"f"})}),"?"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.em,{children:(0,t.jsx)(n.code,{children:"f"})})," is something which connects ",(0,t.jsx)(n.code,{children:"state"})," and ",(0,t.jsx)(n.code,{children:"UI"}),".\nYou may say it is component tree with its render function. And you are ",(0,t.jsx)("abbr",{title:"In My Opinion",children:"IMO"})," partialy right."]}),"\n",(0,t.jsxs)(n.p,{children:["Because this ",(0,t.jsx)(n.em,{children:(0,t.jsx)(n.code,{children:"f"})}),' function usually produces many UI pieces,\nit is "neccesity" to split the mental load into reusable smaller ',(0,t.jsx)(n.code,{children:"f"}),"s - components.\n",(0,t.jsx)(n.a,{href:"https://overreacted.io/a-chain-reaction/",children:"Dan Abramov"})," great article about it."]}),"\n",(0,t.jsx)(n.p,{children:"Example. React components ergonomics."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-tsx",children:"fucntion Post(slug) {                  // name and state received via props\n    const posts = useQuery(fetchPosts) // state received via hook\n    const post = posts[slug]           // derivation logic\n    return <div>{post}</div>           // JSX UI description\n}\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Name"})," of function to be referencable."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Receive state"})," via props or hooks (or higher order components)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Derive state"})," before JSX is produced. Right within render function or separated into custom function."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Produce UI description"})," in a form of JSX which is then consumed by VDOM."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"I said partialy. Components does not (usually) directly connects to states. They just receives a value/connection."}),"\n",(0,t.jsx)(n.h2,{id:"connecting-state",children:"Connecting state"}),"\n",(0,t.jsx)(n.p,{children:"We need some way to choose states our component depends on. We want to subscribe/observe changes and execute derivation and rendering logic with new values."}),"\n",(0,t.jsxs)(n.p,{children:["Hooks do a great job with its smart ",(0,t.jsx)(n.code,{children:"useEffect"})," and ",(0,t.jsx)(n.code,{children:"useRef"}),". Much hated for its ergonomics, but ",(0,t.jsx)("abbr",{title:"In My Opinion",children:"IMO"})," does the job conceptually right.\nLets call custom hooks using ",(0,t.jsx)(n.code,{children:"useEffect"})," and ",(0,t.jsx)(n.code,{children:"useRef"})," ",(0,t.jsx)(n.strong,{children:"connection hooks"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Example. React connection hook ergonomics."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-tsx",children:"// name and config received via props\nfucntion useStopwatch(delay) {          \n    const [ticks, setTicks] = useState(0)\n    useEffect(() => {         \n        // subscribing to real world state (time)            \n        const timer = setInterval(() => setTicks(prev => prev + 1), delay)\n        return () => clearInterval(timer)\n    }, [delay])\n    // Returning reactive state\n    return ticks                          \n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Many libraries like ",(0,t.jsx)(n.code,{children:"tanstack-query"})," for external resources, ",(0,t.jsx)(n.code,{children:"react-router"})," for URL or ",(0,t.jsx)(n.code,{children:"react-use"})," for many kind of states were created.\nThey allows us (app devs) to connect to the source state with one line of code from within the component. And dont car much how."]}),"\n",(0,t.jsx)(n.p,{children:"Those connecting hooks are a missing glue between state and a component render logic.\nThey subscribe to the state changes and make necessary derivation and rednering logic re-run accordingly."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)("abbr",{title:"In My Opinion",children:"IMO"})," observer pattern is best for DX. But sometimes it is not possible or desired. Usually for performance.\nTypically for states far away from client like server data.\nEven for them we have mechanisms like websockets or long polling.\nBut usually we fallback to initial fetch during either component mount, server request or build.\nThen caching, invalidation and optimistic update mechanisms must enter the scene.\nBut call them connecting hooks anyway."]}),"\n",(0,t.jsxs)(n.p,{children:["There are hooks which creates state itself like ",(0,t.jsx)(n.code,{children:"useState"})," and ",(0,t.jsx)(n.code,{children:"useReducer"}),". And simultaneously connects to it.\nBut lets stick with connecting word only."]}),"\n",(0,t.jsx)(n.h2,{id:"developer-experience",children:"Developer experience"}),"\n",(0,t.jsxs)(n.p,{children:["So the real world picture of ",(0,t.jsx)(n.code,{children:"UI = f(state)"})," for App developers could be squeezed into:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"DOM = render(derive(connect(holistic_state)))\n"})}),"\n",(0,t.jsxs)(n.p,{children:["It is super simple mental model for such a complex problem as web app. It is ",(0,t.jsx)(n.strong,{children:"conceptually clean and mentally relieving"}),".\nModern client-side ",(0,t.jsx)("abbr",{title:"Single Page Application",children:"SPA"})," follows this conceptual model quite precisly.\nI believe many devs love React 16.8+ (hooks introduced) because of this mental model. Me included.\nIt speeds up developments, saves time and money."]}),"\n",(0,t.jsx)(n.p,{children:"But to model be helpful some additional properties must be meet."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Composable"})," - Ability to compose components into the full UI.",(0,t.jsx)("br",{}),"\nAbility to ",(0,t.jsx)("mark",{children:"place any component into any other component"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Reusable"})," - Ability to define name and reuse component in different place.",(0,t.jsx)("br",{}),"\nAlso ability to pass arbitrary configuration (possibly reactive state) to adjust its behavior (props)."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Colocated"})," - Name, render logic, necessary state connetions, state derivation logic, documentation etc.",(0,t.jsx)("br",{}),"\nDevs should be able to ",(0,t.jsx)("mark",{children:"place all those dependencies inside component"}),".",(0,t.jsx)("br",{}),"\nIf not, devs jumps back and forth in a codebase. Inconvenient."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Encapsulated"})," - Ability to work on a component independently by default. Opt-in to break barier.",(0,t.jsx)("br",{}),"\nIf not met, dev must mentaly thing about other code pieces.\nNote: this is broken by React cascading memoization. Frustraiting."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Reactive"})," - Component must react on connected state the dev chooses.",(0,t.jsx)("br",{}),"\n",(0,t.jsx)("mark",{children:"Any component must be able to connect to any state"}),". The same applies for derivation hooks.",(0,t.jsx)("br",{}),"\nIf some rules are required, it makes the development jammed."]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Arbitrary"})," - The components boundaries must obey to the dev needs.",(0,t.jsx)("br",{}),"\n",(0,t.jsx)("mark",{children:"Nothing must forces component to split (or not to split)"}),".",(0,t.jsx)("br",{}),"\nSame for derivation hooks. It destroys their purpose otherwise."]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Why all of it matters? Because the Conceptual model needs to be solid. All the time.\nIf we develop some complex logic with those principles in mind it cant happen due to broken principles that we need to refactor.\nI wan to trust it will support me during heavy loads."}),"\n",(0,t.jsx)(n.p,{children:"I can handle some configuration and syntax overhead like useEffect, css integration or Webpack.\nI'm fine to write few extra chars if the conceptual model stays clear."}),"\n",(0,t.jsxs)(n.p,{children:["Client ",(0,t.jsx)("abbr",{title:"Single Page Application",children:"SPA"}),"s also suffers bad performance. I believe that conceptual model is so important, it should not be broken by enforcing good performance patterns.\nFramework should remain loyal to the clear model and do its best for performance. In addition provide tools to optimize like optimization hints, refactoring patterns or more aggressive caching config."]}),"\n",(0,t.jsxs)(n.p,{children:["It seems to me ",(0,t.jsx)("abbr",{title:"React Server Components",children:"RSC"})," and NextJS just ",(0,t.jsx)("mark",{children:"broking some of fundamental properties of this conceptual model"})," because of its performance-first design.\nAnd I believe it is not necessary to achieve their goals.\nBut lets end positive and keep this to the next article."]}),"\n",(0,t.jsx)(n.p,{children:"Thanks for reading."})]})}function h(e={}){const{wrapper:n}={...(0,o.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},7472:(e,n,s)=>{s.d(n,{I:()=>a,M:()=>r});var t=s(5668);const o={},i=t.createContext(o);function r(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);