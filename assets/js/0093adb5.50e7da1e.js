"use strict";(self.webpackChunk_torrta_docs=self.webpackChunk_torrta_docs||[]).push([[12],{6152:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var s=t(7e3),r=t(7472);const i={sidebar_position:1},o="Notes",a={id:"notes",title:"Notes",description:"Environments/Runtime - build,edge,server,client",source:"@site/docs/notes.mdx",sourceDirName:".",slug:"/notes",permalink:"/docs/notes",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"sidebar",previous:{title:"What is Torrta",permalink:"/docs/What is Torrta"},next:{title:"Tutorial - Basics",permalink:"/docs/category/tutorial---basics"}},c={},l=[];function d(e){const n={code:"code",h1:"h1",p:"p",pre:"pre",...(0,r.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"notes",children:"Notes"}),"\n",(0,s.jsx)(n.p,{children:"Environments/Runtime - build,edge,server,client"}),"\n",(0,s.jsx)(n.p,{children:"Kinf of satisfied when single environment is used. Basically we had client. But now it is horrible. We need framework/standard how to work on multiple environments."}),"\n",(0,s.jsx)(n.p,{children:"The problem is performance. But we loosing DX. A lot. I want to change it."}),"\n",(0,s.jsx)(n.p,{children:"I have a lot of opinions. Im confident with some and Im not with others. But I know I can be missing some points. Please let me know so I can learn and inject edits to my posts for future readers."}),"\n",(0,s.jsx)(n.p,{children:"I realize some of them are controversial. You will most likely disagree with some. But also agree with some. Tell me both. And also why. Twitter."}),"\n",(0,s.jsx)(n.p,{children:"When to trigger -"}),"\n",(0,s.jsx)(n.p,{children:"Server and Edge is alive. Like client. Can be rerendered. But asynchronously."}),"\n",(0,s.jsx)(n.p,{children:"prerendering - Shell"}),"\n",(0,s.jsx)(n.p,{children:"Suspence/ErrorBoundaries vs. returning loading/error/success state"}),"\n",(0,s.jsx)(n.p,{children:"Environment boundaries. They can overlap. How?"}),"\n",(0,s.jsx)(n.p,{children:"Mutations - Actions"}),"\n",(0,s.jsx)(n.p,{children:"Functional without javascript - Actions - form"}),"\n",(0,s.jsx)(n.p,{children:"Wait for Suspense vs. Stream right away - Streaming - on which environment?"}),"\n",(0,s.jsx)(n.p,{children:"Bundle splitting - NO"}),"\n",(0,s.jsx)(n.p,{children:"Minimize Client javascript - Also security. Also something (node APIs, file system, ...) cant be accessed form client side."}),"\n",(0,s.jsx)(n.p,{children:"Resumability -"}),"\n",(0,s.jsx)(n.p,{children:"Security - Ability to disallow exposing build/edge/server data/API to client, use server secrets,"}),"\n",(0,s.jsx)(n.p,{children:"By default it tries to push anything to the first possible environment/runtime (performance + security)"}),"\n",(0,s.jsx)(n.p,{children:"Prefetching - Perfromance, load with parameters inside component render function. Or without paramaters outside component at init (request). Prefetch just by passing initial value to next environment."}),"\n",(0,s.jsx)(n.p,{children:"Where (on which enviro/runtime) component runs the render function (or signal tree) is defined by"}),"\n",(0,s.jsx)(n.p,{children:"Environments could be guarded. eg. @GuardEnvironment('build')"}),"\n",(0,s.jsx)(n.p,{children:"Waterfalls - Performance - Hoisting up"}),"\n",(0,s.jsx)(n.p,{children:"DX - async Load triggered nearby components"}),"\n",(0,s.jsx)(n.p,{children:"Prototyping is a huge part of coding. Single file."}),"\n",(0,s.jsx)(n.p,{children:"Dont force me to split component. I am in charge."}),"\n",(0,s.jsx)(n.p,{children:"Single API for fetching"}),"\n",(0,s.jsx)(n.p,{children:"Serializing parameters"}),"\n",(0,s.jsx)(n.p,{children:"Rerender on cache key/request id/tag/deps change"}),"\n",(0,s.jsx)(n.p,{children:"caching - NO"}),"\n",(0,s.jsx)(n.p,{children:"routing - NO"}),"\n",(0,s.jsx)(n.p,{children:"Everything is state/resource = Component uses it and modifies it, async state is a problem"}),"\n",(0,s.jsx)(n.p,{children:"State defines from which environmetns it can be accessed."}),"\n",(0,s.jsx)(n.p,{children:"Compilation. How much it needs to understand our code beforhand. / Compilation magic. = Bad DX"}),"\n",(0,s.jsx)(n.p,{children:"Blog, API, Discussion/Twitter?"}),"\n",(0,s.jsx)(n.p,{children:"Basically limit role of page and layout. Just use regular components instead."}),"\n",(0,s.jsx)(n.p,{children:"Websockets are ideal UX+DX. But performance..."}),"\n",(0,s.jsx)(n.p,{children:"Component needs environment if it uses some environment resource. accepts some props from parent component which needs the environament.\nOr if it passes callbacks to child component which need the envorionment.\nOr if it uses needs function\nOr it uses some hook which needs the environemnt."}),"\n",(0,s.jsx)(n.p,{children:"Dont want to export mutation from file by name (export loader; export GET)\nbecause I want to be able to have more in one file."}),"\n",(0,s.jsx)(n.p,{children:"Start with examples\nSSG, SSR, CSR, single file prototype, real world file structure,\nppr, streaming\nprefetching buld => ppr, build => server, build => ssr, build => client"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="API"',children:"\n/**\n * Its like two arrays of environemnts:\n * needToRun = [] // is empty by default\n * ableToRun = [build, edge, server, client]\n * \n * component is run on most left environment from ableToRun and all of envs in needToRun\n * if \n */\n\n/**\n * Marks component or hook that it needs to run on (e.g. localstorage needs client or cookies needs client or server or filestorage needss server or like useEffect needs client)\n * It also means javascript will be bundled and shipped to that environment.\n * OR is used between multiple environments.\n * It makes to rerender the component when it first enter on environamnet where it is used. e.g. if it was prerendered on previous environemnt.\n * It does not to avoid rendering on different environemnts.\n * It is used for reducing shipped bundle size and reducing rerenders.\n * It effectivly replaces 'use client directive'\n * Not it will be mostly not used by app developers. But just library developers.\n * \n * Its effective scope spreads to other components.\n *\n * Component needs environment if it uses some environment resource. accepts some props from parent component which needs the environament.\n * Or if it passes callbacks to child component which need the envorionment.\n * Or if it uses needs function\n * Or it uses some hook which needs the environemnt. \n */\nfunction needs(...environments);\n\n/**\n * It is used mostly to guard component that it needs to run on some environemnt. So some deep nested 'needs' function is not called.\n * It yells error ideally at build time when it founds same needed enviornemnt. \n * Note it is not required to use. But helps to keep performance good.\n * Because it stops you accidentaly use some expensive resource.\n */\nfunction guradOnly(...environments);\n\n/**\n * Triggers when asyncCallback changes or inside hooks rerenders.\n */\nconst useHook = registerResource(asyncCallback, {\n\n})\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",children:"import { usePathParam, useSearchParam, useCookie, useLocalStorage, useEnvVar } from '@torrta'\n\nconst usePosts = registerResource(() => {\n  guradOnly('server')\n  return fetch('/api/posts')\n}, {\n\n})\n\nconst usePosts = createResource(() => {\n  needs('client')\n  avoid('client')\n  return fetch('/api/posts')\n}, {\n\n})\n\nconst usePost = createUseAsync({\n  fn: (id) => fetch(`/api/posts/${id}`),\n  trigger: 'init' | 'render',\n})\n\nconst usePost2 = createUseAsync({\n  fn: () => {\n    const id = usePathParam('postId')\n    return fetch(`/api/posts/${id}`)\n  },\n  trigger: [''],\n  suspense: false,\n})\n\nexport const MyComponent = ({ id }) => {\n\n  const posts = usePosts()\n\n  const post = usePost(id)\n\n  return (<>\n    <div>{posts.length}</div>\n    <div>{post}</div>\n  </>)\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"This component can be run on all environments\nBut is rerendered only during build\nIts JS is stripped from all other environments"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",children:"export const HelloWorld = () => {\n  return (\n    <div>Hello world</div> \n  )\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Component can refuse to run on some environments => resulting in error\nComponent can force environment to wait for async operation => resulting in pause on Streaming\nComponent can suspend environment rendering => resulting in triggering suspense"}),"\n",(0,s.jsx)(n.p,{children:"This component can run on all environments"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="/app/Page.jsx"',children:"import { useBuildEnvVar, useBuildUrl } from '@torrta'\n\nexport const Page = () => {\n  const isDev = useBuildEnvVar('build', 'PROD')\n  const isDev = usePassValueToServer(isDev)\n  const url = useBuildUrl()\n  return (\n    <MyComponent/> \n  )\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="/app/MyComponent.jsx"',children:"export const MyComponent = () => {\n  const [tabId] = useState()\n  const tabContent = useTab(tabId, { suspense: false })\n  const posts = usePosts({ waitFor: ['build', 'server', 'edge', 'client'] }) // UI, loading, ...\n  return (\n    <div>{tabContent}</div> \n  )\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="/app/backendClient.jsx"',children:"export const useTab = registerResource((tabId) => {\n  guradOnly('server')\n  return fs.readFile(`/tabs/${tabId}.txt`)\n})\n\n\nexport const usePosts = registerResource(() => {\n  guardOnly('build', 'server', 'edge') // bundling, javascript compilation, buindle size, features runtime available\n  return fetch(`/api/rests`)\n}, {\n  triggerRefetch: ['build-start', 'build-render', 'server-start', 'server-request', 'server-render', 'client-start', 'client-render', 'time', 'tag-revalidation'], // default by number of params, must use *-render if params are present, TS check\n  caching, refetching, freshness, staleTime, stalePeriod,\n  allowCreateEndpoint: true\n})\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="/app/MyComponent.jsx"',children:'export const MyComponent = () => {\n  const { Form, mutate } = usePostMutation()\n  return (\n    <Form><input name="here"/></Form> \n  )\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="/app/mutations.jsx"',children:"export const usePostMutation = registerMutation((tabId, tabContent) => {\n  guradOnly('server')\n  return fs.writeFile(`/tabs/${tabId}.txt`, { tabContent })\n})\n\nexport const usePostMutation = registerMutation((tabId, tabContent) => {\n  guradOnly('server')\n  return fetch(`/tabs/${tabId}.txt`, { tabContent })\n})\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="/app/initialValue.jsx"',children:"export const MyComponent = () => {\n  const [tabId] = useState()\n  const postsBuild = usePostsBuild({ waitFor: ['build', 'server', 'edge', 'client'] }) // \n  const postsRequest = usePosts({ suspense: false }) // \n  const posts = postsRequest ?? postsBuild;\n  return (\n    <div>{tabContent}</div> \n  )\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-jsx",metastring:'title="/app/backendClient.jsx"',children:"export const usePosts = registerResource(() => {\n  guardOnly('build', 'server', 'edge') // bundling, javascript compilation, buindle size, features runtime available\n  return fetch(`/api/rests`)\n}, {\n  triggerRefetch: ['build-start', 'build-render', 'server-start', 'server-request', 'server-render', 'client-start', 'client-render', 'time', 'tag-revalidation'], // default by number of params, must use *-render if params are present, TS check\n  caching, refetching, freshness, staleTime, stalePeriod\n})\n"})})]})}function u(e={}){const{wrapper:n}={...(0,r.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},7472:(e,n,t)=>{t.d(n,{I:()=>a,M:()=>o});var s=t(5668);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);